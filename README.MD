# TipMaker - STM32 Stepper Motor Controller

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![STM32F103C8T6](https://img.shields.io/badge/STM32-STM32F103C8T6-blue)](https://www.st.com/en/microcontrollers-microprocessors/stm32f103c8.html)

A sophisticated stepper motor controller system based on STM32F103C8T6 (Blue Pill) featuring USB CDC communication, INA236 current monitoring, and programmable motion sequences.

## Table of Contents
- [Features](#features)
- [Hardware Requirements](#hardware-requirements)
- [Software Requirements](#software-requirements)
- [Project Structure](#project-structure)
- [Getting Started](#getting-started)
  - [1. Clone the Repository](#1-clone-the-repository)
  - [2. Install Toolchain](#2-install-toolchain)
  - [3. Generate Code with CubeMX](#3-generate-code-with-cubemx)
  - [4. Build the Project](#4-build-the-project)
  - [5. Flash to STM32](#5-flash-to-stm32)
- [Hardware Connections](#hardware-connections)
- [Serial Command Reference](#serial-command-reference)
  - [Command Format](#command-format)
  - [Available Commands](#available-commands)
  - [JSON Response Format](#json-response-format)
- [Configuration Parameters](#configuration-parameters)
- [Troubleshooting](#troubleshooting)
- [License](#license)

## Features

- **USB CDC Communication**: Virtual COM port for easy PC communication
- **Stepper Motor Control**: Precise PWM control with hardware pulse counting
- **Current Monitoring**: INA236 I2C current sensor with 8-sample buffer
- **Programmable Sequences**: State machine for automated operations
- **Non-volatile Storage**: EEPROM emulation for parameter persistence
- **JSON Interface**: All responses in standardized JSON format
- **Modular Architecture**: Clean separation of concerns for easy maintenance

## Hardware Requirements

1. **Main Controller**:
   - STM32F103C8T6 (Blue Pill) development board

2. **Stepper Motor Driver**:
   - Any stepper driver accepting CW/CCW pulses
   - 5V compatible control signals

3. **Current Sensing**:
   - INA236 current sensor (I2C interface)

4. **Power Supply**:
   - 3.3V for STM32
   - Appropriate voltage for stepper motor

5. **Connectivity**:
   - USB Type-A to Micro-USB cable
   - Logic level converters (if needed)

## Software Requirements

1. **STM32CubeMX** (v6.0+): For initial project configuration
2. **ARM GNU Toolchain**:
   - gcc-arm-none-eabi
   - make
3. **OpenOCD**: For flashing and debugging
4. **Serial Terminal**:
   - PuTTY (Windows)
   - screen/minicom (Linux/Mac)
   - CoolTerm (Cross-platform)

## Project Structure

```
tip_maker/
├── Core/                 # STM32 core files (generated by CubeMX)
│   ├── Inc/             # Header files
│   ├── Src/             # Source files
│   └── Startup/         # Startup code
├── Drivers/             # HAL and CMSIS drivers
├── App/                 # Application code
│   ├── Inc/             # Application headers
│   │   ├── stepper_motor.h
│   │   ├── ina236.h
│   │   ├── command_parser.h
│   │   ├── sequence_controller.h
│   │   ├── eeprom_emulation.h
│   │   └── system_state.h
│   └── Src/             # Application sources
├── Makefile             # Build configuration
├── README.md            # This file
└── README_CN.md         # Chinese documentation
```

## TODO

- fix round count
- make PCB
- build documentation

## Getting Started

### 1. Clone the Repository
```bash
git clone https://github.com/Astro-Aionia/tip_maker.git
cd tip_maker
```

### 2. Install Toolchain

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install make gcc-arm-none-eabi openocd
```

**macOS (Homebrew):**
```bash
brew install arm-none-eabi-gcc make openocd
```

**Windows:**
1. Download and install [ARM GNU Toolchain](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm)
2. Install [Make for Windows](http://gnuwin32.sourceforge.net/packages/make.htm)
3. Install [OpenOCD](https://gnutoolchains.com/arm-eabi/openocd/)

### 3. Generate Code with CubeMX
1. Open STM32CubeMX
2. Load `tip_maker.ioc` (if available)
3. Or create new project with STM32F103C8Tx
4. Configure as described in the configuration guide
5. Generate code with Toolchain/IDE set to "Makefile"

### 4. Build the Project
```bash
make all
```
Successful build will create `build/tip_maker.elf` and `build/tip_maker.bin`.

### 5. Flash to STM32

**Using ST-Link:**
```bash
make flash
```
Or manually:
```bash
openocd -f interface/stlink-v2.cfg -f target/stm32f1x.cfg \
  -c "program build/tip_maker.elf verify reset exit"
```

**Using USB DFU:**
1. Set BOOT0=1, BOOT1=0
2. Reset the board
3. Flash using DFU tools

## Hardware Connections

| STM32 Pin | Function | Connection | Notes |
|-----------|----------|------------|-------|
| PA8 | PWM_CW | Driver CW input | 5V tolerant |
| PA9 | PWM_CCW | Driver CCW input | 5V tolerant |
| PA0 | SWITCH_CURRENT | Diode switch control | Active high |
| PA1 | SWITCH_HOLDOFF | Motor holdoff control | ON=False, OFF=True |
| PA2 | SWITCH_DIVISION | Division selection | Active high |
| PA3 | INPUT_ROUNDOUT | Motor round output | Pull-up input |
| PA4 | INPUT_ZERO | Zero point indicator | Pull-up input |
| PB6 | I2C1_SCL | INA236 SCL | 400kHz Fast Mode |
| PB7 | I2C1_SDA | INA236 SDA | 400kHz Fast Mode |
| PA11 | USB_DM | USB D- | |
| PA12 | USB_DP | USB D+ | |

## Serial Command Reference

### Command Format
```
COMMAND [PARAMETER] [VALUE]
```
- All commands are ASCII strings
- Parameters are separated by spaces
- End command with Enter/Return (CR/LF)
- Commands are case-sensitive

### Available Commands

#### 1. SET - Configure Parameters
```
SET {Key} {Value}
```
**Keys and Values:**
- `FREQ`: 0-1000 Hz (integer)
- `THRES`: Current threshold (uA integer)
- `CURRENT`: ON/OFF (diode switch)
- `HOLDOFF`: ON/OFF (motor holdoff, ON=False, OFF=True)
- `DIVISION`: ON/OFF (division selection)

**Example:**
```
SET FREQ 500
SET THRES 20
SET CURRENT ON
```

#### 2. GET - Read Parameters
```
GET {Key}
```
**Example:**
```
GET FREQ
GET THRES
```

#### 3. MOVE - Control Motor Movement
```
MOVE {Dir} {Step}
```
- `Dir`: CW or CCW
- `Step`: Number of pulses (1-65535)

**Example:**
```
MOVE CW 1000
MOVE CCW 500
```

#### 4. POLL - Read Current Buffer
```
POLL
```
Returns all 8 current samples from the buffer.

#### 5. START - Begin Sequence Operation
```
START
```
Triggers the automated sequence operation.

#### 6. STATUS - Get System Status
```
STATUS {Level}
```
- `Level`: 1, 2, or 3
  - 1: User-configurable parameters
  - 2: Level 1 + last current reading
  - 3: Full system status

**Example:**
```
STATUS 3
```

#### 7. DEBUG - Enable Debug Mode
```
DEBUG {Level}
```
- `Level`: 0-3
  - 0: Disable debug output
  - 1-3: Same as STATUS levels, repeated every second

**Example:**
```
DEBUG 2
DEBUG 0
```

### JSON Response Format

All responses follow this structure:
```json
{
  "Cmd": "COMMAND_NAME",
  "Status": "Success/Error",
  ... additional fields ...
}
```

#### Example Responses:

**Successful SET:**
```json
{
  "Cmd": "SET",
  "Status": "Success",
  "Parameter": "FREQ",
  "Value": "500"
}
```

**Successful MOVE:**
```json
{
  "Cmd": "MOVE",
  "Status": "Success",
  "Direction": "CW",
  "Step": 1000
}
```

**STATUS Level 3:**
```json
{
  "Cmd": "STATUS",
  "Status": "Success",
  "Level": 3,
  "FREQ": 500,
  "THRES": 20,
  "CURRENT": "ON",
  "HOLDOFF": "OFF",
  "DIVISION": "ON",
  "LastCurrent": 0.045,
  "MotorMoving": false,
  "TargetSteps": 1000,
  "CurrentSteps": 1000,
  "CurrentDirection": "S",
  "RoundCount": 5,
  "ZeroPoint": false
}
```

**Error Response:**
```json
{
  "Cmd": "SET",
  "Status": "Error",
  "Parameter": "FREQ",
  "Value": "1500"
}
```

## Configuration Parameters

The system maintains the following parameters:

| Parameter | Type | Range | Default | Description |
|-----------|------|-------|---------|-------------|
| origin_freq | uint16_t | 1000 Hz | 1000 | Fixed PWM frequency |
| freq | uint16_t | 0-1000 Hz | 500 | User adjustable frequency |
| threshold | int16_t | - | 0.1 | Current threshold (A) |
| switch_current | bool | ON/OFF | OFF | Diode switch state |
| switch_holdoff | bool | ON/OFF | OFF | Motor holdoff state |
| switch_division | bool | ON/OFF | OFF | Division selection |
| buffer_size | uint8_t | 8 | 8 | Current buffer size |
| round_count | uint16_t | 0-65535 | 0 | Motor round counter |
| zero_point | bool | true/false | false | Zero position indicator |

## Troubleshooting

### Common Issues:

1. **USB Not Detected**:
   - Check USB cable connection
   - Install appropriate USB CDC drivers
   - Ensure proper power supply

2. **I2C Communication Failures**:
   - Verify pull-up resistors (4.7kΩ) on SDA/SCL
   - Check INA236 address (default 0x40)
   - Verify power to INA236

3. **Motor Not Moving**:
   - Check PWM signal with oscilloscope
   - Verify motor driver power
   - Confirm control signal voltage levels

4. **Build Errors**:
   - Ensure ARM toolchain is in PATH
   - Check Makefile configuration
   - Verify CubeMX generated files

5. **Flash Failures**:
   - Check ST-Link connection
   - Verify BOOT pin settings
   - Try different USB port/cable

### Debug Tips:

1. Enable debug mode for detailed output:
   ```
   DEBUG 3
   ```

2. Check all parameters:
   ```
   STATUS 3
   ```

3. Monitor current readings:
   ```
   POLL
   ```

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Acknowledgments

- STMicroelectronics for STM32CubeMX and HAL libraries
- ARM for GNU toolchain
- OpenOCD developers
- All contributors and testers

## Support

For issues and questions:
1. Check the troubleshooting section
2. Review open/closed GitHub issues
3. Create a new issue with detailed information

---

*Project maintained by [Aionia/PKU]*
